/*
Trying out DNS library with C# for fun. 

This program would redirect all traffic to www.microsoft.com to localhost 
Can actually just change host file and do ipconfig /flushdns

Meanwhile, run the fake microsoft server to return a 200 status code to pass the
`InternetCheckConnectionW` API for the next stage 

If using this program, make sure to 

```
Install-Package DNS 
```

And set the DNS server of the VM to localhost as well 
*/


using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

using System.IO;
using System.Net;
using System.Net.Sockets;
using System.Threading.Tasks;
using DNS;
using DNS.Protocol;
using DNS.Client;
using DNS.Server;
using DNS.Client.RequestResolver;
using System.Threading;
using DNS.Protocol.ResourceRecords;

namespace DoPlugsDNS
{
    class Program
    {
        public class LocalRequestResolver : IRequestResolver
        {
            public Task<IResponse> Resolve(IRequest request, CancellationToken cancellationToken = default)
            {
                IResponse response = Response.FromRequest(request);
                foreach(Question question in response.Questions)
                {
                    Console.WriteLine(question.Name);
                    if (question.Type == RecordType.A && question.Name.ToString().Contains("www.microsoft.com"))
                    {
                        Console.WriteLine("[Malware checking for internet connection] - Redirecting *.microsoft.com -> localhost");
                        IResourceRecord record = new IPAddressResourceRecord(
                            question.Name,
                            IPAddress.Parse("127.0.0.1"));
                        response.AnswerRecords.Add(record);
                    }
                }
                return Task.FromResult(response);
                throw new NotImplementedException();
            }
        }
        static async Task Main(string[] args)
        {
            Console.Out.WriteLine("\nStarting Doplugs Fake DNS Server to redirect https://www.microsoft.com to localhost (Yes we can add to hostfile as well actually) ...\n");
            DnsServer server = new DnsServer(new LocalRequestResolver());
            await server.Listen();
        }
    }
}
